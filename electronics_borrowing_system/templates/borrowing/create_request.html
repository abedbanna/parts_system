{% extends 'base.html' %}

{% block title %}طلب استعارة جديد - {{ block.super }}{% endblock %}

{% block extra_css %}
<style>
    :root {
        --primary-color: #667eea;
        --success-color: #28a745;
        --danger-color: #dc3545;
        --warning-color: #f39c12;
        --border-radius: 12px;
    }

    .form-container {
        background: white;
        border-radius: var(--border-radius);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        padding: 2rem;
        margin-bottom: 2rem;
    }

    .step-indicator {
        display: flex;
        justify-content: center;
        margin-bottom: 2rem;
        position: relative;
    }

    .step-indicator::before {
        content: '';
        position: absolute;
        top: 20px;
        left: 35%;
        width: 30%;
        height: 2px;
        background: #dee2e6;
        z-index: 1;
    }

    .step {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #dee2e6;
        color: #6c757d;
        font-weight: 600;
        position: relative;
        z-index: 2;
        margin: 0 2rem;
        transition: all 0.3s ease;
    }

    .step.active {
        background: var(--primary-color);
        color: white;
        transform: scale(1.1);
    }

    .step.completed {
        background: var(--success-color);
        color: white;
    }

    .step-label {
        position: absolute;
        top: 50px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 0.85rem;
        font-weight: 500;
        color: #6c757d;
        white-space: nowrap;
    }

    .step.active .step-label {
        color: var(--primary-color);
        font-weight: 600;
    }

    /* IMPORTANT: Step visibility control */
    .step-content {
        display: none !important;
    }

    .step-content.show {
        display: block !important;
        animation: fadeIn 0.5s ease-out;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-label {
        font-weight: 600;
        color: #495057;
        margin-bottom: 0.5rem;
    }

    .form-control, .form-select {
        border: 2px solid #e9ecef;
        border-radius: 8px;
        padding: 0.75rem;
        transition: all 0.3s ease;
    }

    .form-control:focus, .form-select:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.1);
    }

    .part-item {
        background: #f8f9fa;
        border: 2px solid #e9ecef;
        border-radius: var(--border-radius);
        padding: 1.5rem;
        margin-bottom: 1rem;
        position: relative;
        transition: all 0.3s ease;
    }

    .part-item:hover {
        border-color: var(--primary-color);
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .part-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .part-number {
        background: var(--primary-color);
        color: white;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 0.85rem;
    }

    .remove-part-btn {
        background: var(--danger-color);
        color: white;
        border: none;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .remove-part-btn:hover {
        background: #c82333;
        transform: scale(1.1);
    }

    .add-part-btn {
        background: var(--success-color);
        border: none;
        color: white;
        padding: 0.8rem 2rem;
        border-radius: var(--border-radius);
        font-weight: 600;
        transition: all 0.3s ease;
    }

    .add-part-btn:hover {
        background: #218838;
        transform: translateY(-2px);
        color: white;
    }

    .btn-navigation {
        padding: 0.8rem 2.5rem;
        border-radius: var(--border-radius);
        font-weight: 600;
        transition: all 0.3s ease;
        border: 2px solid transparent;
    }

    .btn-next {
        background: var(--primary-color);
        color: white;
    }

    .btn-next:hover {
        background: #5a6fd8;
        transform: translateY(-2px);
        color: white;
    }

    .btn-prev {
        background: transparent;
        color: #6c757d;
        border-color: #dee2e6;
    }

    .btn-prev:hover {
        background: #f8f9fa;
        border-color: #adb5bd;
        color: #495057;
    }

    .progress-bar-custom {
        height: 6px;
        background: #e9ecef;
        border-radius: 3px;
        overflow: hidden;
        margin-bottom: 2rem;
    }

    .progress-fill {
        height: 100%;
        background: var(--primary-color);
        transition: width 0.5s ease;
    }

    .sidebar-card {
        background: white;
        border-radius: var(--border-radius);
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 1.5rem;
        overflow: hidden;
    }

    .sidebar-card .card-header {
        background: transparent;
        border-bottom: 1px solid #dee2e6;
        padding: 1rem 1.25rem;
        margin-bottom: 0;
    }

    .sidebar-card .card-body {
        padding: 1.25rem;
    }

    .sidebar-card .card-title {
        margin-bottom: 0;
        font-size: 1rem;
        font-weight: 600;
    }

    .popular-part-item {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 0.8rem;
        margin-bottom: 0.8rem;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 1px solid transparent;
    }

    .popular-part-item:hover {
        background: #e9ecef;
        border-color: var(--primary-color);
        transform: scale(1.02);
    }

    .popular-part-item:last-child {
        margin-bottom: 0;
    }

    .quick-fill-btn {
        background: var(--success-color);
        color: white;
        border: none;
        padding: 0.4rem 0.8rem;
        border-radius: 6px;
        font-size: 0.85rem;
        margin: 0.2rem;
        transition: all 0.3s ease;
    }

    .quick-fill-btn:hover {
        background: #218838;
        transform: scale(1.05);
    }

    .review-section {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1.5rem;
        margin-top: 2rem;
    }

    .review-item {
        padding: 0.8rem 0;
        border-bottom: 1px solid #dee2e6;
    }

    .review-item:last-child {
        border-bottom: none;
    }

    .instruction-item {
        display: flex;
        align-items: start;
        margin-bottom: 1rem;
        padding: 0;
    }

    .instruction-item:last-child {
        margin-bottom: 0;
    }

    .instruction-icon {
        width: 35px;
        height: 35px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-left: 0.75rem;
        flex-shrink: 0;
        color: white;
        font-size: 0.9rem;
    }

    .quick-fill-section {
        background: #e8f5e8;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1.5rem;
        border: 1px solid #c3e6cb;
    }

    @media (max-width: 768px) {
        .form-container {
            padding: 1rem;
        }

        .step {
            margin: 0 1rem;
        }

        .part-item {
            padding: 1rem;
        }

        .sidebar-card {
            margin-bottom: 1rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="fw-bold mb-2">
                    <i class="fas fa-plus-circle me-2"></i>
                    طلب استعارة جديد
                </h1>
                <p class="text-muted">أكمل الخطوات التالية لإنشاء طلب استعارة احترافي</p>
            </div>
            <div class="text-end">
                <span class="badge bg-primary px-3 py-2">
                    <i class="fas fa-user me-2"></i>
                    {{ user.get_full_name|default:user.username }}
                </span>
            </div>
        </div>
    </div>
</div>

<!-- Progress Bar -->
<div class="progress-bar-custom">
    <div class="progress-fill" id="progressBar" style="width: 50%;"></div>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="form-container">
            <!-- Step Indicator -->
            <div class="step-indicator">
                <div class="step active" data-step="1">
                    <i class="fas fa-info-circle"></i>
                    <div class="step-label">معلومات الطلب</div>
                </div>
                <div class="step" data-step="2">
                    <i class="fas fa-microchip"></i>
                    <div class="step-label">القطع وإرسال</div>
                </div>
            </div>

            <form method="post" action="{% url 'borrowing:create_request' %}" id="borrowingForm" novalidate>
                {% csrf_token %}

                <!-- STEP 1: Request Information -->
                <div class="step-content show" id="step1">
                    <div class="mb-4">
                        <h5 class="text-primary mb-3">
                            <i class="fas fa-info-circle me-2"></i>
                            معلومات الطلب الأساسية
                        </h5>
                        <p class="text-muted small">أدخل التفاصيل الأساسية لطلب الاستعارة</p>
                    </div>

                    <div class="form-group">
                        <label for="id_purpose" class="form-label">الغرض من الاستعارة *</label>
                        <textarea class="form-control" id="id_purpose" name="purpose" rows="3"
                                  placeholder="اشرح سبب احتياجك للقطع الإلكترونية..." required></textarea>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="id_expected_return_date" class="form-label">تاريخ الإرجاع المتوقع *</label>
                                <input type="date" class="form-control" id="id_expected_return_date"
                                       name="expected_return_date" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="project_type" class="form-label">نوع المشروع</label>
                                <select class="form-select" id="project_type">
                                    <option value="">اختر نوع المشروع</option>
                                    <option value="graduation">مشروع تخرج</option>
                                    <option value="assignment">مهمة دراسية</option>
                                    <option value="research">بحث علمي</option>
                                    <option value="personal">مشروع شخصي</option>
                                    <option value="other">أخرى</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="id_student_notes" class="form-label">ملاحظات إضافية</label>
                        <textarea class="form-control" id="id_student_notes" name="student_notes" rows="2"
                                  placeholder="أي معلومات إضافية قد تكون مفيدة..."></textarea>
                    </div>

                    <div class="quick-fill-section">
                        <h6 class="text-success mb-2">
                            <i class="fas fa-magic me-2"></i>
                            نماذج سريعة للأغراض الشائعة
                        </h6>
                        <button type="button" class="quick-fill-btn" onclick="quickFill('مشروع تخرج - نظام إنترنت الأشياء')">
                            مشروع تخرج IoT
                        </button>
                        <button type="button" class="quick-fill-btn" onclick="quickFill('مهمة مقرر الأردوينو والبرمجة')">
                            مهمة Arduino
                        </button>
                        <button type="button" class="quick-fill-btn" onclick="quickFill('بحث في الذكاء الاصطناعي والروبوتات')">
                            بحث AI
                        </button>
                        <button type="button" class="quick-fill-btn" onclick="quickFill('ورشة عمل تطبيقية للطلاب')">
                            ورشة عمل
                        </button>
                    </div>
                </div>

                <!-- STEP 2: Parts Selection & Submit -->
                <div class="step-content" id="step2">
                    <div class="mb-4">
                        <h5 class="text-primary mb-3">
                            <i class="fas fa-microchip me-2"></i>
                            القطع المطلوبة
                        </h5>
                        <p class="text-muted small">أضف القطع الإلكترونية التي تحتاجها لمشروعك</p>
                    </div>

                    <div id="partsContainer">
                        <!-- Default first part -->
                        <div class="part-item" data-part-index="0">
                            <div class="part-header">
                                <div class="part-number">1</div>
                                <h6 class="flex-grow-1 mx-3 mb-0">القطعة رقم 1</h6>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label">اسم القطعة *</label>
                                        <input type="text" class="form-control" name="part_name_0"
                                               placeholder="مثال: Arduino Uno R3" required>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label class="form-label">الكمية *</label>
                                        <input type="number" class="form-control" name="quantity_0"
                                               min="1" value="1" required>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label class="form-label">الحالة المطلوبة</label>
                                        <select class="form-select" name="condition_0">
                                            <option value="excellent">ممتازة</option>
                                            <option value="good">جيدة</option>
                                            <option value="fair">مقبولة</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="text-center mt-4">
                        <button type="button" class="add-part-btn" onclick="addNewPart()">
                            <i class="fas fa-plus me-2"></i>
                            إضافة قطعة أخرى
                        </button>
                    </div>

                    <!-- DEBUG: Test Submit Button -->
                    <div class="text-center mt-3">
                        <button type="button" class="btn btn-sm btn-outline-info" onclick="testSubmit()">
                            <i class="fas fa-bug me-2"></i>
                            اختبار الإرسال
                        </button>
                    </div>

                    <!-- Review Section -->
                    <div class="review-section">
                        <h6 class="text-secondary mb-3">
                            <i class="fas fa-eye me-2"></i>
                            ملخص الطلب
                        </h6>

                        <div class="review-item">
                            <div class="row">
                                <div class="col-sm-4"><strong>الغرض:</strong></div>
                                <div class="col-sm-8" id="reviewPurpose">-</div>
                            </div>
                        </div>

                        <div class="review-item">
                            <div class="row">
                                <div class="col-sm-4"><strong>تاريخ الإرجاع:</strong></div>
                                <div class="col-sm-8" id="reviewReturnDate">-</div>
                            </div>
                        </div>

                        <div class="review-item">
                            <div class="row">
                                <div class="col-sm-4"><strong>عدد القطع:</strong></div>
                                <div class="col-sm-8" id="reviewPartsCount">-</div>
                            </div>
                        </div>

                        <div class="review-item">
                            <h6 class="text-secondary mb-2">القطع المطلوبة:</h6>
                            <div id="reviewPartsList" class="mt-2"></div>
                        </div>
                    </div>

                    <div class="alert alert-info mt-4">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>ملاحظة:</strong> ستتم مراجعة طلبك من قبل الإدارة خلال 24 ساعة. سيتم إشعارك بالقرار عبر البريد الإلكتروني.
                    </div>
                </div>

                <!-- Navigation Buttons -->
                <div class="d-flex justify-content-between align-items-center mt-4 pt-3 border-top">
                    <button type="button" class="btn btn-prev btn-navigation" id="prevBtn"
                            onclick="goToStep(1)" style="visibility: hidden;">
                        <i class="fas fa-arrow-right me-2"></i>
                        السابق
                    </button>

                    <div class="text-muted small">
                        الخطوة <span id="currentStepNum">1</span> من 2
                    </div>

                    <button type="button" class="btn btn-next btn-navigation" id="nextBtn" onclick="goToStep(2)">
                        التالي
                        <i class="fas fa-arrow-left ms-2"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div class="col-lg-4">
        <!-- Instructions Card -->
        <div class="sidebar-card">
            <div class="card-header">
                <h5 class="card-title text-primary">
                    <i class="fas fa-lightbulb me-2"></i>
                    إرشادات مهمة
                </h5>
            </div>
            <div class="card-body">
                <div class="instruction-item">
                    <div class="instruction-icon bg-primary">
                        <i class="fas fa-info-circle"></i>
                    </div>
                    <div>
                        <strong>حدد الغرض بوضوح</strong><br>
                        <small class="text-muted">اشرح سبب احتياجك للقطع بتفصيل</small>
                    </div>
                </div>

                <div class="instruction-item">
                    <div class="instruction-icon bg-success">
                        <i class="fas fa-calendar"></i>
                    </div>
                    <div>
                        <strong>تاريخ إرجاع واقعي</strong><br>
                        <small class="text-muted">احسب الوقت المطلوب بدقة</small>
                    </div>
                </div>

                <div class="instruction-item">
                    <div class="instruction-icon bg-warning">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div>
                        <strong>مراجعة خلال 24 ساعة</strong><br>
                        <small class="text-muted">سيتم الرد على طلبك قريباً</small>
                    </div>
                </div>

                <div class="instruction-item">
                    <div class="instruction-icon bg-info">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <div>
                        <strong>المحافظة على القطع</strong><br>
                        <small class="text-muted">أعدها بنفس الحالة المستلمة</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Popular Parts Card -->
        <div class="sidebar-card">
            <div class="card-header">
                <h5 class="card-title text-warning">
                    <i class="fas fa-star me-2"></i>
                    القطع الشائعة
                </h5>
                <small class="text-muted">انقر لإضافة سريعة</small>
            </div>
            <div class="card-body">
                <div class="popular-part-item" onclick="addPopularPart('Arduino Uno R3')">
                    <i class="fas fa-microchip me-2 text-primary"></i>
                    <strong>Arduino Uno R3</strong>
                    <br><small class="text-muted">متحكم دقيق للمشاريع</small>
                </div>

                <div class="popular-part-item" onclick="addPopularPart('Breadboard Full Size')">
                    <i class="fas fa-th me-2 text-success"></i>
                    <strong>Breadboard</strong>
                    <br><small class="text-muted">لوحة توصيل بدون لحام</small>
                </div>

                <div class="popular-part-item" onclick="addPopularPart('LED Kit (Red, Green, Blue)')">
                    <i class="fas fa-lightbulb me-2 text-warning"></i>
                    <strong>مجموعة LED</strong>
                    <br><small class="text-muted">أضواء ملونة للمشاريع</small>
                </div>

                <div class="popular-part-item" onclick="addPopularPart('Resistor Kit (220Ω - 10kΩ)')">
                    <i class="fas fa-minus me-2 text-info"></i>
                    <strong>مجموعة مقاومات</strong>
                    <br><small class="text-muted">قيم مختلفة للدوائر</small>
                </div>

                <div class="popular-part-item" onclick="addPopularPart('Jumper Wires Set')">
                    <i class="fas fa-plug me-2 text-danger"></i>
                    <strong>أسلاك توصيل</strong>
                    <br><small class="text-muted">ذكر وأنثى ومختلط</small>
                </div>
            </div>
        </div>

        <!-- Help Card -->
        <div class="sidebar-card">
            <div class="card-body text-center">
                <i class="fas fa-question-circle fa-2x text-primary mb-3"></i>
                <h6>تحتاج مساعدة؟</h6>
                <p class="small text-muted mb-3">تواصل مع فريق الدعم الفني</p>
                <a href="#" class="btn btn-outline-primary btn-sm">
                    <i class="fas fa-headset me-2"></i>
                    الدعم الفني
                </a>
            </div>
        </div>
    </div>
</div>

<script>
let currentStep = 1;
let partCounter = 1;

// Initialize form
document.addEventListener('DOMContentLoaded', function() {
    showStep(1);
    updateNavigationButtons();
    console.log('Form initialized - showing step 1');
});

function showStep(stepNumber) {
    console.log('showStep called with:', stepNumber);

    // Hide all steps
    document.querySelectorAll('.step-content').forEach(step => {
        step.classList.remove('show');
        console.log('Hiding step:', step.id);
    });

    // Show target step
    const targetStep = document.getElementById('step' + stepNumber);
    if (targetStep) {
        targetStep.classList.add('show');
        console.log('Showing step:', targetStep.id);
        console.log('Step has show class:', targetStep.classList.contains('show'));
    } else {
        console.error('Step not found: step' + stepNumber);
    }

    currentStep = stepNumber;
    updateStepIndicator();
    updateProgressBar();

    if (stepNumber === 2) {
        updateReviewSection();
    }

    // Double-check visibility
    setTimeout(() => {
        const step1 = document.getElementById('step1');
        const step2 = document.getElementById('step2');
        console.log('Step 1 visible:', step1.classList.contains('show'));
        console.log('Step 2 visible:', step2.classList.contains('show'));
    }, 100);
}

function goToStep(stepNumber) {
    console.log('Going to step:', stepNumber);

    // When going to step 2, only validate step 1
    if (stepNumber === 2 && !validateStep1()) {
        console.log('Step 1 validation failed');
        return;
    }

    showStep(stepNumber);
    updateNavigationButtons();

    // Smooth scroll to top
    document.querySelector('.form-container').scrollIntoView({ behavior: 'smooth' });
}

function updateStepIndicator() {
    document.querySelectorAll('.step').forEach(step => {
        const stepNum = parseInt(step.dataset.step);
        step.classList.remove('active', 'completed');

        if (stepNum === currentStep) {
            step.classList.add('active');
        } else if (stepNum < currentStep) {
            step.classList.add('completed');
            step.innerHTML = '<i class="fas fa-check"></i><div class="step-label">' +
                           (stepNum === 1 ? 'معلومات الطلب' : 'القطع وإرسال') + '</div>';
        } else {
            // Reset to original icons for future steps
            if (stepNum === 1) {
                step.innerHTML = '<i class="fas fa-info-circle"></i><div class="step-label">معلومات الطلب</div>';
            } else {
                step.innerHTML = '<i class="fas fa-microchip"></i><div class="step-label">القطع وإرسال</div>';
            }
        }
    });

    document.getElementById('currentStepNum').textContent = currentStep;
}

function updateProgressBar() {
    const progress = (currentStep / 2) * 100;
    document.getElementById('progressBar').style.width = progress + '%';
}

function updateNavigationButtons() {
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');

    console.log('Updating navigation buttons for step:', currentStep);

    // Previous button
    if (currentStep === 1) {
        prevBtn.style.visibility = 'hidden';
    } else {
        prevBtn.style.visibility = 'visible';
    }

    // Next/Submit button
    if (currentStep === 2) {
        nextBtn.innerHTML = '<i class="fas fa-paper-plane me-2"></i>إرسال الطلب';
        nextBtn.type = 'button';  // Important: keep as button, not submit
        nextBtn.onclick = function() {
            console.log('Submit button clicked!');
            submitForm();
        };
        console.log('Submit button configured');
    } else {
        nextBtn.innerHTML = 'التالي <i class="fas fa-arrow-left ms-2"></i>';
        nextBtn.type = 'button';
        nextBtn.onclick = function() {
            console.log('Next button clicked!');
            goToStep(2);
        };
        console.log('Next button configured');
    }
}

function validateStep1() {
    const purpose = document.querySelector('#id_purpose').value.trim();
    const returnDate = document.querySelector('#id_expected_return_date').value;

    if (!purpose) {
        alert('يرجى إدخال الغرض من الاستعارة');
        return false;
    }
    if (!returnDate) {
        alert('يرجى تحديد تاريخ الإرجاع المتوقع');
        return false;
    }

    // Check if return date is in the future
    if (returnDate && new Date(returnDate) <= new Date()) {
        alert('يجب أن يكون تاريخ الإرجاع في المستقبل');
        return false;
    }

    return true;
}

function validateStep2() {
    const partInputs = document.querySelectorAll('[name^="part_name_"]');
    let hasValidPart = false;

    partInputs.forEach(input => {
        if (input.value.trim()) hasValidPart = true;
    });

    if (!hasValidPart) {
        alert('يرجى إضافة قطعة واحدة على الأقل');
        return false;
    }

    return true;
}

function addNewPart() {
    const container = document.getElementById('partsContainer');
    const newPartHtml = `
        <div class="part-item" data-part-index="${partCounter}">
            <div class="part-header">
                <div class="part-number">${partCounter + 1}</div>
                <h6 class="flex-grow-1 mx-3 mb-0">القطعة رقم ${partCounter + 1}</h6>
                <button type="button" class="remove-part-btn" onclick="removePart(this)">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">اسم القطعة *</label>
                        <input type="text" class="form-control" name="part_name_${partCounter}"
                               placeholder="مثال: Arduino Uno R3" required>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="form-label">الكمية *</label>
                        <input type="number" class="form-control" name="quantity_${partCounter}"
                               min="1" value="1" required>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="form-label">الحالة المطلوبة</label>
                        <select class="form-select" name="condition_${partCounter}">
                            <option value="excellent">ممتازة</option>
                            <option value="good">جيدة</option>
                            <option value="fair">مقبولة</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    `;

    container.insertAdjacentHTML('beforeend', newPartHtml);
    partCounter++;

    // Smooth scroll to new part
    container.lastElementChild.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function removePart(button) {
    if (confirm('هل أنت متأكد من حذف هذه القطعة؟')) {
        const partItem = button.closest('.part-item');
        partItem.style.transition = 'all 0.3s ease';
        partItem.style.transform = 'translateX(100%)';
        partItem.style.opacity = '0';

        setTimeout(() => {
            partItem.remove();
            updatePartNumbers();
            updateReviewSection();
        }, 300);
    }
}

function updatePartNumbers() {
    const partItems = document.querySelectorAll('.part-item');
    partItems.forEach((item, index) => {
        const number = item.querySelector('.part-number');
        const title = item.querySelector('h6');
        number.textContent = index + 1;
        title.textContent = `القطعة رقم ${index + 1}`;
    });
}

function addPopularPart(partName) {
    // Find the first empty part name field or add a new part
    const partInputs = document.querySelectorAll('[name^="part_name_"]');
    let addedToExisting = false;

    for (let input of partInputs) {
        if (!input.value.trim()) {
            input.value = partName;
            input.focus();
            addedToExisting = true;
            break;
        }
    }

    if (!addedToExisting) {
        addNewPart();
        setTimeout(() => {
            const newInput = document.querySelector(`[name="part_name_${partCounter - 1}"]`);
            if (newInput) {
                newInput.value = partName;
            }
        }, 100);
    }

    // Update review if on step 2
    if (currentStep === 2) {
        setTimeout(updateReviewSection, 200);
    }

    showToast('تم إضافة ' + partName + ' إلى القائمة', 'success');
}

function quickFill(purposeText) {
    document.querySelector('#id_purpose').value = purposeText;
    showToast('تم ملء الغرض تلقائياً', 'success');
}

function updateReviewSection() {
    // Update purpose
    const purpose = document.querySelector('#id_purpose').value;
    document.getElementById('reviewPurpose').textContent = purpose || '-';

    // Update return date
    const returnDate = document.querySelector('#id_expected_return_date').value;
    document.getElementById('reviewReturnDate').textContent = returnDate || '-';

    // Update parts list
    const partInputs = document.querySelectorAll('[name^="part_name_"]');
    const quantityInputs = document.querySelectorAll('[name^="quantity_"]');
    const partsList = document.getElementById('reviewPartsList');

    let partsHtml = '';
    let partsCount = 0;

    partInputs.forEach((input, index) => {
        if (input.value.trim()) {
            const quantity = quantityInputs[index]?.value || '1';
            partsHtml += `
                <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                    <span><strong>${input.value}</strong></span>
                    <span class="badge bg-primary">${quantity} قطعة</span>
                </div>
            `;
            partsCount++;
        }
    });

    partsList.innerHTML = partsHtml || '<div class="text-muted">لم يتم إضافة أي قطع</div>';
    document.getElementById('reviewPartsCount').textContent = partsCount + ' قطعة';
}

// Test function for debugging
function testSubmit() {
    console.log('=== TEST SUBMIT FUNCTION ===');

    // Check if we can find all required elements
    const form = document.getElementById('borrowingForm');
    const purpose = document.querySelector('#id_purpose');
    const returnDate = document.querySelector('#id_expected_return_date');
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');

    console.log('Form element:', form);
    console.log('Purpose field:', purpose, purpose?.value);
    console.log('Return date field:', returnDate, returnDate?.value);
    console.log('CSRF token:', csrfToken, csrfToken?.value);

    // Check parts
    const partInputs = document.querySelectorAll('[name^="part_name_"]');
    console.log('Part inputs found:', partInputs.length);
    partInputs.forEach((input, index) => {
        console.log(`Part ${index}:`, input.value);
    });

    // Try simple form submission without validation
    if (form) {
        console.log('Attempting direct form submission...');

        // Add a simple test part if none exist
        if (partInputs.length === 0 || !partInputs[0].value.trim()) {
            const testPartInput = document.createElement('input');
            testPartInput.type = 'hidden';
            testPartInput.name = 'part_name_0';
            testPartInput.value = 'Test Part';
            form.appendChild(testPartInput);

            const testQuantityInput = document.createElement('input');
            testQuantityInput.type = 'hidden';
            testQuantityInput.name = 'quantity_0';
            testQuantityInput.value = '1';
            form.appendChild(testQuantityInput);

            const testConditionInput = document.createElement('input');
            testConditionInput.type = 'hidden';
            testConditionInput.name = 'condition_0';
            testConditionInput.value = 'excellent';
            form.appendChild(testConditionInput);

            console.log('Added test part data');
        }

        // Fill required fields if empty
        if (!purpose?.value) {
            purpose.value = 'Test purpose for debugging';
        }
        if (!returnDate?.value) {
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            returnDate.value = tomorrow.toISOString().split('T')[0];
        }

        console.log('Submitting form...');
        form.submit();
    } else {
        console.error('Form not found!');
        alert('خطأ: لم يتم العثور على النموذج');
    }
}

function submitForm() {
    console.log('=== SUBMITTING FORM ===');

    if (!validateStep1() || !validateStep2()) {
        console.log('Validation failed');
        return;
    }

    // Get the actual form element
    const form = document.getElementById('borrowingForm');

    if (!form) {
        console.error('Form element not found!');
        showToast('خطأ: لم يتم العثور على النموذج', 'danger');
        return;
    }

    // Clear any existing hidden inputs for parts (to avoid duplicates)
    const existingPartInputs = form.querySelectorAll('input[name^="part_name_"], input[name^="quantity_"], input[name^="condition_"]');
    existingPartInputs.forEach(input => {
        if (input.type === 'hidden') {
            input.remove();
        }
    });

    // Add parts data as hidden inputs to the actual form
    const partInputs = document.querySelectorAll('[name^="part_name_"]');
    const quantityInputs = document.querySelectorAll('[name^="quantity_"]');
    const conditionInputs = document.querySelectorAll('[name^="condition_"]');

    let partsAdded = 0;
    partInputs.forEach((input, index) => {
        if (input.value.trim()) {
            // Create hidden inputs for this part
            const partNameInput = document.createElement('input');
            partNameInput.type = 'hidden';
            partNameInput.name = `part_name_${partsAdded}`;
            partNameInput.value = input.value.trim();
            form.appendChild(partNameInput);

            const quantityInput = document.createElement('input');
            quantityInput.type = 'hidden';
            quantityInput.name = `quantity_${partsAdded}`;
            quantityInput.value = quantityInputs[index]?.value || '1';
            form.appendChild(quantityInput);

            const conditionInput = document.createElement('input');
            conditionInput.type = 'hidden';
            conditionInput.name = `condition_${partsAdded}`;
            conditionInput.value = conditionInputs[index]?.value || 'excellent';
            form.appendChild(conditionInput);

            partsAdded++;
            console.log(`Added part ${partsAdded}: ${input.value.trim()}`);
        }
    });

    console.log(`Total parts added: ${partsAdded}`);

    if (partsAdded === 0) {
        console.error('No parts added!');
        showToast('خطأ: لم يتم إضافة أي قطع', 'danger');
        return;
    }

    // Debug: Log all form data
    const formData = new FormData(form);
    console.log('=== FORM DATA ===');
    for (let [key, value] of formData.entries()) {
        console.log(`${key}: ${value}`);
    }

    // Show loading state
    const submitBtn = document.getElementById('nextBtn');
    const originalText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>جاري الإرسال...';

    // Simple form submission (most reliable)
    console.log('Submitting form via regular POST...');

    try {
        form.submit();
        console.log('Form submitted successfully');
    } catch (error) {
        console.error('Form submission error:', error);
        showToast('خطأ في إرسال النموذج: ' + error.message, 'danger');
        // Restore button state
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    }
}

function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} position-fixed`;
    toast.style.cssText = `
        top: 20px; left: 50%; transform: translateX(-50%);
        z-index: 10000; min-width: 300px; text-align: center;
        animation: slideDown 0.3s ease-out;
    `;
    toast.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check' : 'info'}-circle me-2"></i>
        ${message}
    `;

    document.body.appendChild(toast);

    setTimeout(() => {
        toast.style.animation = 'slideUp 0.3s ease-out';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// Add CSS animations
const style = document.createElement('style');
style.textContent = `
    @keyframes slideDown {
        from { transform: translateX(-50%) translateY(-100%); opacity: 0; }
        to { transform: translateX(-50%) translateY(0); opacity: 1; }
    }
    @keyframes slideUp {
        from { transform: translateX(-50%) translateY(0); opacity: 1; }
        to { transform: translateX(-50%) translateY(-100%); opacity: 0; }
    }
`;
document.head.appendChild(style);

// Auto-update review section when on step 2
document.addEventListener('input', function(e) {
    if (currentStep === 2 && (e.target.name.startsWith('part_name_') || e.target.name.startsWith('quantity_'))) {
        updateReviewSection();
    }
});
</script>
{% endblock %}
